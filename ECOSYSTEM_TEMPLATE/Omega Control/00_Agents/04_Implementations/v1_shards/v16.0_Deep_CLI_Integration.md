# V16 Implementation Plan: The "Omegafied" Dual-Vector Architecture
**Location:** `Omega DEV Panel/Implementations/v16.0_Deep_CLI_Integration.md`

## üéØ The Final Boss Vision
The user wants the absolute maximum velocity and cost-efficiency out of the Omega Ecosystem. We will abandon single-threaded execution and instead build an **"Omegafied" Dual-Vector System**. 

Omega Claw will act as a master Orchestrator capable of simultaneously controlling TWO distinct execution engines:
1. **Vector 1 (The Stealth Engine):** A headless CLI agent (`claude`) running invisibly in the terminal via `pexpect`.
2. **Vector 2 (The Phantom Engine):** A GUI Automation agent driving the Antigravity Desktop App via `pyautogui` and Computer Vision.

By running these together, the system can work twice as fast on the Hive queue. When Claude Code inevitably hits its usage limits, the Orchestrator gracefully falls back to relying 100% on the Phantom Engine, seamlessly clicking UI buttons to swap Antigravity tokens to Gemini/DeepSeek until Claude's limits reset.

---

## ‚öôÔ∏è Architecture & Technology Stack

### Vector 1: The Stealth Engine (Terminal)
- **Tooling:** Python's `pexpect` library.
- **Workflow:** Omega Claw spawns `claude` in an invisible background terminal. It intercepts Claude's `(y/n)` prompts, automatically approves them (based on Autonomy mode), and parses the stdout.
- **Limit Detection:** The agent actively monitors the terminal output for the string *"You have run out of messages"*.

### Vector 2: The Phantom Engine (GUI Automation)
- **Tooling:** 
  - `pyautogui`: To physically move the mouse and type keys.
  - `pyobjc`: AppleScript bridge to force Antigravity to the absolute front of the screen.
  - `opencv` / `pytesseract`: To screenshot the IDE and visually detect "Allow" buttons or "Limit Reached" popups.
- **Workflow:** Omega Claw forces Antigravity open, types the intent into the chat box, and hits Enter. It visually monitors the screen to click buttons on your behalf.
- **Warning:** When Vector 2 is active, *the Mac is hostage*. You cannot touch your mouse or keyboard, making this the ultimate "Sleep Mode" weapon.

---

## üèóÔ∏è The Hive Logistics (How They Work Together)

1. **The Parallel Burn:** You drop 4 jobs into the Hive via Telegram before bed.
2. **Vector 1 Dispatch:** Omega Claw assigns Job #1 to the stealth `claude` terminal.
3. **Vector 2 Dispatch:** Omega Claw immediately assigns Job #2 to the Phantom Antigravity App.
4. **The Failover:** When Vector 1 (Claude) hits its message cap, Omega Claw suspends the terminal and assigns Job #3 to Vector 2. 
5. **The GUI Swap:** If Vector 2 (Antigravity) hits an API cap on Claude 3.5, the Computer Vision detects the error text. The Phantom Engine triggers a mouse macro to physically click the "Model Dropdown" in the UI, switches to "Gemini 1.5 Pro", and presses "Retry".

This ensures maximum speed (parallel execution) and maximum cost-efficiency (burning flat-rate quotas before rotating free APIs).

## üöÄ Execution Steps (Phase 1 ‚Äî Local Ghost Agent)
1. **DB Setup:** Add Autonomy Tiers to `db.py`. ‚úÖ 
2. **Telegram UI:** Build the `/mode` Inline UI to define autonomy levels. ‚úÖ
3. **The Stealth Engine:** Install `pexpect` and structure `TerminalAgent.py`. ‚úÖ (Verified)
4. **The Phantom Engine:** Install `pyautogui` / `osascript`, sandbox GUI test passed. ‚úÖ (Verified)
5. **The Bridge:** Connect Telegram `/stealth` and `/phantom` intents to Orchestrator. ‚úÖ
6. **Computer Vision Loop:** Build the `vision_watch_loop` using `pytesseract` OCR. ‚úÖ
7. **Model Rotation Macro:** Build auto-swap / auto-approve logic. ‚úÖ
8. **Multi-Monitor Hardening:** Support for dual-monitor setups (target secondary screens). ‚úÖ **BATTLE-READY**

---

## üëª Phase 1.5 ‚Äî Advanced Ghost Logic (Hardware-Specific Automation)
**Goal:** Full autonomy inside the Antigravity IDE.

1. **Mapping System:** Create `landmarks.json` or equivalent to store UI offsets for standard resolutions (2048x1152 detected).
2. **Accept All Macro:** Use OpenCV/Tesseract to find the blue "Accept All" button position and physically click it.
3. **Model Swap Macro:**
   - Detect "Limit Hit" toast.
   - Click "Model Selector" dropdown (Bottom-Center).
   - Scroll and select "Gemini 3.1 Pro" or "Flash" (as per user preference).
4. **Pause/Play Detection:** Understand when the agent is "Thinking" vs "Idle".
5. **Stealth-to-Phantom Handoff:**
   - If Vector 1 (Claude Code CLI) prints "Rate limit reached", the Orchestrator automatically pauses Vector 1 and re-dispatches the job to Vector 2 (Antigravity).

---

## üèéÔ∏è Phase 1.6 ‚Äî Ultra-Optimized Ghost Logic (Watchdog & Routing)
**Goal:** Professional-grade resilience and model-specific task routing.

1. **Universal Window Scaling:**
   - Use `osascript` to force the IDE window to a standard size/percentage of the screen on startup.
   - Ensures `landmarks.json` remains accurate regardless of manual resizing.
2. **Task-Based Model Routing:**
   - **Planning Mode:** Switch to `Gemini 3.1 Pro (High)` for cheaper/faster reasoning.
   - **Building Mode:** Switch to `Claude Opus 4.6` for complex code synthesis.
   - **Failover Mode:** Revert to `Gemini 3 Flash` on all limits.
3. **Advanced Watchdog:**
   - **Idle Detection:** 10-minute timer if no screen change.
   - **Crash Detection:** OCR for "Application Not Responding" or "Keep Waiting" popups.
   - **Auto-Rescue:** Click "Keep Waiting" to try and unfreeze the IDE.
4. **Telegram Failover Alerts:**
   - If Rescue fails after 3 attempts, send a "MEGA PROBLEM" alert to Telegram with a screenshot.
   - Suggest remote login via Tailscale/Chrome Remote Desktop.

---

---

## üîÆ Phase 2 ‚Äî VPS Cloud Factory (Future / V17)
**Goal:** Eliminate the "hostage Mac" problem entirely.

1. **Cloud Desktop:** Spin up a VPS (DigitalOcean / Hetzner / AWS) running Ubuntu + XFCE or a lightweight desktop environment.
2. **Container Isolation:** Run the Phantom Engine inside a Docker container with a virtual display (`Xvfb` or `xdotool` for headless GUI automation).
3. **Remote Mapping:** Omega Claw on the user's local machine SSH-tunnels commands to the VPS. The VPS has its own "virtual mouse" ‚Äî the user's real Mac stays completely untouched.
4. **24/7 Factory:** The VPS runs perpetually. Telegram messages trigger builds on the cloud machine. The user can use their local Mac freely while the VPS crunches code.
5. **Multi-VPS Scaling:** In theory, you could spin up N containers, each running a Phantom Engine instance, and process N jobs in parallel. True horizontal scaling.

---

## üõ°Ô∏è Phase 3 ‚Äî Auto-Init Bootstrapper (Future / V17)
**Goal:** Zero-config first-run experience.

1. **Constitution Clone:** On first boot, if the Constitution directory doesn't exist, Omega Claw automatically `git clone`s it from the public repo.
2. **Dependency Check:** Auto-detect if `pyautogui`, `pexpect`, `pytesseract` are installed. If not, auto-install them.
3. **Accessibility Permission Wizard:** Guide the user through granting `System Settings ‚Üí Privacy ‚Üí Accessibility` permissions for Python so the Phantom Engine can control the mouse.
4. **Screen Calibration:** On first Phantom run, take a screenshot and auto-detect the IDE's chat input box coordinates using template matching (OpenCV), so the user never has to manually calibrate pixel positions.

