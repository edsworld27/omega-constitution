# ğŸ”’ SECURITY.XML AUDIT â€” Omega Claw

**Audited Against**: SECURITY.xml v4.0 (Impenetrable Edition)
**Scope**: All 12 source files in `omega-claw/`
**Date**: 2026-02-26

---

## Findings Summary

| # | Severity | SECURITY.xml Rule | File | Finding | Status |
|---|----------|-------------------|------|---------|--------|
| 1 | ğŸ”´ CRITICAL | Â§4.5 Encryption At Rest | `db/database.py` | SQLite DB `chmod 600` owner-only | âœ… FIXED |
| 2 | ğŸ”´ CRITICAL | Â§2.1 All Inputs Malicious | `orchestrator_agent/__init__.py` | Strict allowlist (alpha+spaces, max 50) | âœ… FIXED |
| 3 | ğŸŸ  HIGH | Â§0.8 Fail Secure | `telegram_bot.py:58` | Generic error to user, full trace in logs | âœ… FIXED |
| 4 | ğŸŸ  HIGH | Â§5.4 Auth Bypass | `telegram_bot.py:20` | Deny-by-default if ALLOWED_USERS empty | âœ… FIXED |
| 5 | ğŸŸ¡ MEDIUM | Â§3.3 Agent Capability Matrix | All agents | Formal matrix on BaseAgent + all subclasses | âœ… FIXED |
| 6 | ğŸŸ¡ MEDIUM | Â§3.7 Race Conditions | `orchestrator_agent/__init__.py` | `fcntl.flock()` on state file reads/writes | âœ… FIXED |
| 7 | ğŸŸ¡ MEDIUM | Â§2.2 Output Sanitization | `orchestrator_agent/__init__.py` | `_escape_md()` on all user-supplied output | âœ… FIXED |
| 8 | ğŸŸ¢ LOW | Â§3.4 Hallucination Containment | `core/skill_loader.py` | Forbidden import scan + SHA-256 hash trust | âœ… FIXED |

---

## Detailed Analysis

### ğŸ”´ Finding 1: SQLite Plaintext (Â§4.5)

**Rule**: *"All databases containing PII, credentials, or sensitive business data are encrypted at rest"*

**Violation**: `db/database.py` stores:
- Telegram user IDs (PII)
- Full message text from Telegram
- Bot responses
- Job metadata

All in an **unencrypted SQLite file** at `~/.omega-claw/omega_claw.db`.

**Fix**: Use `sqlcipher` (encrypted SQLite) or encrypt the DB directory with OS-level encryption. Set file permissions to `0600`.

---

### ğŸ”´ Finding 2: Unsanitized Input â†’ File Write (Â§2.1)

**Rule**: *"Every input is treated as malicious until validated"*

**Violation**: `orchestrator_agent/__init__.py:91-92`
```python
slug = self._slugify(answers["name"])
job_file = os.path.join(self.telegram_inbox, f"{job_id}-{slug}.md")
```

The `_slugify()` method strips most special chars, BUT: the project name is also written **directly into the .md file body** without escaping. A crafted name could inject Markdown/instructions into the FOUNDER_JOB that Claude Code then reads as legitimate.

**Fix**: Strict allowlist validation on project name (alphanumeric + spaces only, max 50 chars).

---

### ğŸŸ  Finding 3: Error Leakage (Â§0.8)

**Rule**: *"Fail in a secure state"*

**Violation**: `telegram_bot.py:58`
```python
await update.message.reply_text(f"âŒ Error: {str(e)}")
```

Internal Python exceptions (stack traces, file paths, module names) are sent directly to the Telegram user.

**Fix**: Return a generic error message. Log the full exception internally.

---

### ğŸŸ  Finding 4: Open Access by Default (Â§5.4)

**Rule**: *"Deny-by-default: access is denied unless explicitly granted"*

**Violation**: `telegram_bot.py:20`
```python
if ALLOWED_USERS and user_id not in ALLOWED_USERS:
```

If `TELEGRAM_ALLOWED_USER_IDS` is empty or not set, `ALLOWED_USERS` is an empty list, and `if ALLOWED_USERS` evaluates to `False` â€” **all users are authorized**.

**Fix**: If `ALLOWED_USERS` is empty, deny all access and log a critical warning.

---

### ğŸŸ¡ Finding 5-8: Medium/Low Findings

**5. No Capability Matrix** â€” Agents should have formally declared permitted inputs/outputs/APIs.
**6. Race Conditions** â€” State file needs `fcntl.flock()` or similar.
**7. Output Sanitization** â€” User-supplied names in Markdown could break formatting or inject content.
**8. Skill Trust** â€” `handler.py` files execute arbitrary code. Future: hash verification.

---

## Recommended Fixes (Priority Order)

| Priority | Fix | Effort |
|----------|-----|--------|
| 1 | **Deny-by-default auth** â€” reject if `ALLOWED_USERS` is empty | 2 min |
| 2 | **Generic error messages** â€” never leak exceptions to Telegram | 2 min |
| 3 | **Input validation** â€” allowlist on project name (alpha + spaces, max 50) | 5 min |
| 4 | **DB file permissions** â€” `chmod 600` on SQLite file | 2 min |
| 5 | **SQLite encryption** â€” migrate to `sqlcipher` or add OS-level encryption | 30 min |
| 6 | **State file locking** â€” `fcntl.flock()` on `active_conversations.json` | 10 min |
