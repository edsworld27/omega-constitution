<?xml version="1.0" encoding="UTF-8"?>
<!--
  ============================================================
  OMEGA SOURCES
  ============================================================
  VERSION:      6.0
  STATUS:       LAW
  PURPOSE:      Defines valid sources of information and
                dependency governance. The Agent must strictly
                adhere to this hierarchy when resolving conflicts,
                seeking answers, or adding external code.
  ============================================================
-->

<omega_sources
  version="6.0"
  status="LAW"
  location="constitution/">

  <!-- ============================================================
       PART 1: TRUTH HIERARCHY
  ============================================================ -->

  <truth_hierarchy>

    <!-- TIER 1: THE SUPREME COURT -->
    <tier number="1" name="The Supreme Court" authority="Overrules Everything">
      <description>
        These files are absolute law. If external docs or training data
        conflict with these, these win.
      </description>
      <source order="1" file="SECURITY.xml">Security Constitution</source>
      <source order="2" file="00_rules.md">Project Mandates</source>
      <source order="3" file="deps.md">The Install Gate - if it's not here, it doesn't exist</source>
      <source order="4" file="INTERFACES.md">The API Contract - if endpoint isn't here, it doesn't exist</source>
      <source order="5" file="PROMPTING.xml">Communication Quality Standard</source>
      <source order="6" file="PRACTICES.xml">Operational Wisdom</source>
      <source order="7" file="QUALITY.xml">Error Classification + Audit Protocol</source>
    </tier>

    <!-- TIER 2: PROJECT REALITY -->
    <tier number="2" name="Project Reality" authority="The Current State">
      <description>The specific facts of this build.</description>
      <source order="1" file="02_project_brief.md">The Intent</source>
      <source order="2" file="01_layout.md">The File Map</source>
      <source order="3" file="STATE.md">The Current Position</source>
      <source order="4" path="01_phases/xx/PRD.md">Active PRDs</source>
    </tier>

    <!-- TIER 3: VALIDATED KNOWLEDGE -->
    <tier number="3" name="Validated Knowledge" authority="The Vaults">
      <description>Reusable patterns and confirmed facts.</description>
      <source order="1" path="06_vault/kits/">Approved UI/SaaS/Automation patterns</source>
      <source order="2" path="06_vault/knowledge_vault/">Snippets and lessons learned</source>
      <source order="3">NotebookLM Context (Uploaded PDFs/Docs explicitly tagged as Reference)</source>

      <!-- ANTHROPIC OFFICIAL REFERENCE -->
      <source order="4" name="Claude Cookbooks" url="https://github.com/anthropics/claude-cookbooks" authority="Anthropic Official">
        <description>
          Official Anthropic production-ready patterns for Claude capabilities.
          MIT Licensed. Tier 1 reference for Claude-specific implementations.
        </description>
        <capabilities>
          <capability name="Classification">Text and data classification techniques</capability>
          <capability name="RAG">Retrieval Augmented Generation with external knowledge</capability>
          <capability name="Summarization">Effective text summarization patterns</capability>
          <capability name="Tool Use">Customer service agents, calculators, SQL integration</capability>
          <capability name="Vector DBs">Pinecone RAG, Voyage AI embeddings</capability>
          <capability name="Multimodal">Vision, charts, graphs, forms, PDF extraction</capability>
          <capability name="Sub-agents">Using Haiku as sub-agent with Opus</capability>
          <capability name="JSON Mode">Consistent JSON output patterns</capability>
          <capability name="Prompt Caching">Efficient prompt caching techniques</capability>
          <capability name="Evaluations">Automated prompt evaluation systems</capability>
          <capability name="Moderation">Content moderation filter patterns</capability>
          <capability name="Extended Thinking">Extended reasoning capabilities</capability>
          <capability name="Agent Patterns">Agent design patterns and orchestration</capability>
        </capabilities>
        <usage_rule>
          When implementing Claude-specific features, ALWAYS check Claude Cookbooks first.
          These patterns are battle-tested by Anthropic and supersede generic AI tutorials.
        </usage_rule>
      </source>
    </tier>

    <!-- TIER 4: EXTERNAL VALIDATION -->
    <tier number="4" name="External Validation" authority="Allowed Lookup">
      <description>Where you are allowed to browse/search.</description>
      <source name="Official Documentation Only">e.g., nextjs.org/docs, stripe.com/docs, pypi.org</source>
      <source name="GitHub Issues (Closed/Solved)">For debugging specific errors</source>
      <source name="Claude Cookbooks" url="https://github.com/anthropics/claude-cookbooks" priority="HIGH">
        Anthropic's official Claude implementation patterns. PREFERRED over generic AI tutorials.
      </source>
      <source name="Anthropic Documentation" url="https://docs.anthropic.com" priority="HIGH">
        Official Claude API docs, tool use, and best practices.
      </source>
      <constraint>Do not trust StackOverflow answers older than 18 months without verification.</constraint>
    </tier>

    <!-- TIER 5: FORBIDDEN SOURCES -->
    <tier number="5" name="Forbidden Sources" authority="Hallucination Triggers" forbidden="true">
      <description>You are strictly prohibited from relying on these for business logic or security.</description>
      <source name="Common Sense or General Knowledge">Do not guess business rules. Ask the user.</source>
      <source name="Unverified Tutorials">Medium articles or random blogs.</source>
      <source name="Implicit Assumptions">I assumed you wanted a user login is a violation. Check the PRD.</source>
      <source name="Mock Data as Truth">Never treat 04_tests/fixtures as production data.</source>
    </tier>

  </truth_hierarchy>

  <!-- ============================================================
       RESOLUTION PROTOCOL
  ============================================================ -->

  <resolution_protocol>
    <description>If Tier 1 conflicts with Tier 4:</description>
    <rule>TIER 1 WINS.</rule>
    <example>
      Stripe docs say "paste secret key", SECURITY.xml says "NEVER".
      You follow SECURITY.xml.
    </example>
  </resolution_protocol>

  <!-- ============================================================
       PART 2: DEPENDENCY GOVERNANCE (THE INSTALL GATE)
  ============================================================ -->

  <dependency_governance>

    <install_gate name="Prime Directive">
      <rule>
        It is strictly forbidden to run npm install, pip install, brew install,
        or pull a Docker image unless the package is FIRST declared in deps.md.
      </rule>

      <sequence>
        <step order="1" name="Identify Need">Discover a gap that requires an external tool.</step>
        <step order="2" name="Assess Risk">Check the library's maintenance status, license, and size.</step>
        <step order="3" name="Log Entry">Create a new row in deps.md with a specific version pin.</step>
        <step order="4" name="Update Capabilities">If this adds a major capability, add it to stack.md.</step>
        <step order="5" name="Install">Only after the file is saved, execute the install command.</step>
      </sequence>
    </install_gate>

    <ledger_requirements file="deps.md">
      <description>The deps.md file must act as a precise inventory. Vague entries are not allowed.</description>

      <column name="Package Name" required="true">
        The exact name in the registry (e.g., pandas, framer-motion).
      </column>
      <column name="Version Pin" required="true">
        A strict version number (e.g., 2.1.0).
        Prohibited: Ranges like ^1.2.3 or latest.
        Reason: Determinism. The build must work exactly the same way in 6 months.
      </column>
      <column name="Rationale" required="true">
        Why is this needed? (e.g., Dataframe processing is valid; It's standard is invalid).
      </column>
      <column name="Used In" required="true">
        Which part of the system imports it? (e.g., backend/analysis/).
      </column>
      <column name="Risk/Owner" required="true">
        Who maintains it? (e.g., Meta, Vercel, or Random GitHub User).
      </column>

      <no_bloat_rule>
        Before installing, ask: Can this be done with a standard library or a simple script?
        If the library is over 5MB and used for one function, reject it.
      </no_bloat_rule>
    </ledger_requirements>

    <capability_registry file="stack.md">
      <description>
        While deps.md tracks code packages, stack.md tracks Capabilities.
      </description>

      <when_to_update>
        <trigger>You add a Service (e.g., Supabase, Stripe, OpenAI).</trigger>
        <trigger>You add a Core Tool (e.g., Tailwind, Prisma).</trigger>
        <trigger>You change the Runtime (e.g., Node 18 to 20).</trigger>
      </when_to_update>

      <format>
        <entry type="Service">Name | Auth Location (.env) | SOP Link</entry>
        <entry type="Trigger">Cron / Webhook</entry>
        <entry type="Storage">Database / Bucket</entry>
      </format>
    </capability_registry>

    <supply_chain_security>
      <trusted_sources>
        <rule>Prefer packages from official organizations (e.g., @google-cloud/storage).</rule>
        <rule>Avoid packages with less than 100 stars or no updates in over 12 months.</rule>
      </trusted_sources>

      <license_compliance>
        <permitted>MIT, Apache 2.0, BSD, ISC</permitted>
        <flag_for_review>GPL, AGPL (Copyleft risk)</flag_for_review>
        <forbidden>Proprietary/Commercial without a license key</forbidden>
      </license_compliance>

      <audit_protocol>
        <rule>Run npm audit or pip check before every major release (Phase completion).</rule>
        <rule>Critical vulnerabilities block deployment.</rule>
      </audit_protocol>
    </supply_chain_security>

    <removal_and_archival>
      <description>When a tool is no longer used, it must be surgically removed.</description>
      <step order="1" name="Uninstall">Run the uninstall command.</step>
      <step order="2" name="Clean Code">Remove all imports and dead code paths.</step>
      <step order="3" name="Archive Entry">
        Move the row in deps.md from Active to Archive/Removed.
        Log the date and reason for removal.
      </step>
    </removal_and_archival>

  </dependency_governance>

</omega_sources>
