# API KIT — Starter Pattern

## RESTful Structure
```
GET    /api/v1/[resources]          — List
GET    /api/v1/[resources]/:id      — Get one
POST   /api/v1/[resources]          — Create
PUT    /api/v1/[resources]/:id      — Update (full)
PATCH  /api/v1/[resources]/:id      — Update (partial)
DELETE /api/v1/[resources]/:id      — Delete
```

## Auth Patterns
| Method | Use When | Implementation |
| :--- | :--- | :--- |
| API Key | Server-to-server, simple | Header: X-API-Key |
| JWT | User sessions, stateless | Bearer token, short expiry |
| OAuth 2.0 | Third-party integrations | Authorization Code flow |

## Rate Limiting
| Tier | Limit | Window | Action on Exceed |
| :--- | :--- | :--- | :--- |
| Free | 100 req | per minute | 429 + Retry-After header |
| Pro | 1000 req | per minute | 429 + Retry-After header |
| Burst | 10 req | per second | Queue or reject |

## Versioning Strategy
- URL versioning: /api/v1/, /api/v2/
- No breaking changes within a version
- Deprecation notice 6 months before removal
- Version sunset date in response headers

## Error Response Format
```json
{
  "error": {
    "code": "RESOURCE_NOT_FOUND",
    "message": "The requested resource does not exist.",
    "status": 404,
    "details": {}
  }
}
```

## OpenAPI Template
- [ ] All endpoints documented
- [ ] Request/response schemas defined
- [ ] Auth requirements specified
- [ ] Example requests and responses
- [ ] Error codes documented

## Pagination Pattern
```json
{
  "data": [...],
  "pagination": {
    "page": 1,
    "per_page": 20,
    "total": 150,
    "total_pages": 8,
    "next": "/api/v1/resources?page=2",
    "prev": null
  }
}
```
**Rules:**
- Default page size: 20, max: 100
- Always return pagination metadata
- Support both `page` and `cursor` styles (cursor for real-time feeds)

## Standard HTTP Status Codes
| Code | Meaning | When to Use |
| :--- | :--- | :--- |
| 200 | OK | Successful GET, PUT, PATCH |
| 201 | Created | Successful POST |
| 204 | No Content | Successful DELETE |
| 400 | Bad Request | Validation error |
| 401 | Unauthorized | Missing or invalid auth |
| 403 | Forbidden | Valid auth, insufficient permissions |
| 404 | Not Found | Resource doesn't exist |
| 409 | Conflict | Duplicate or state conflict |
| 422 | Unprocessable | Semantically invalid request |
| 429 | Too Many Requests | Rate limit exceeded |
| 500 | Internal Server Error | Unexpected server failure |

## Health Check Endpoints
```
GET /api/health          — Basic liveness (returns 200)
GET /api/health/ready    — Readiness (checks DB, cache, queues)
```
**Response:**
```json
{
  "status": "healthy",
  "version": "1.2.3",
  "checks": {
    "database": "ok",
    "cache": "ok",
    "queue": "ok"
  }
}
```

## Webhook Design
| Aspect | Pattern |
| :--- | :--- |
| Signature | HMAC-SHA256 in `X-Signature-256` header |
| Retry | 3 attempts with exponential backoff (1s, 10s, 60s) |
| Idempotency | Include `event_id` — receiver deduplicates |
| Timeout | 30 second response timeout |
| Payload | JSON with `event`, `timestamp`, `data` keys |

**Webhook payload format:**
```json
{
  "event": "user.created",
  "event_id": "evt_abc123",
  "timestamp": "2025-01-15T12:00:00Z",
  "data": { ... }
}
```

## Idempotency
- POST and PATCH requests accept an `Idempotency-Key` header
- Server stores the key + response for 24 hours
- Duplicate requests return the cached response, not re-execute
- Key format: UUID v4 generated by the client

## CORS Configuration
```
Access-Control-Allow-Origin: [explicit trusted origins only]
Access-Control-Allow-Methods: GET, POST, PUT, PATCH, DELETE, OPTIONS
Access-Control-Allow-Headers: Content-Type, Authorization, X-API-Key, Idempotency-Key
Access-Control-Max-Age: 86400
```
**Never** use `Access-Control-Allow-Origin: *` on authenticated endpoints.

## Monitoring Requirements
- [ ] Request count per endpoint per minute
- [ ] Response time (p50, p95, p99) per endpoint
- [ ] Error rate per endpoint
- [ ] Rate limit hit count
- [ ] Auth failure count
- [ ] Payload size distribution
- [ ] Alert on: error rate >1%, p95 >500ms, auth failures spike
